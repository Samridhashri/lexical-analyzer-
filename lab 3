#include <stdio.h>
#include <string.h>

#define MAX_STATES 10
#define MAX_SYMBOLS 10

int nfa[MAX_STATES][MAX_SYMBOLS][MAX_STATES];
int nfaStates, nfaSymbols;
char symbols[MAX_SYMBOLS];
int epsilonIndex = -1;

int dfaStates[100][MAX_STATES];
int dfaCount = 0;
int dfaMarked[100];
int dfaTrans[100][MAX_SYMBOLS];

// Check if state already exists in DFA
int isSameSet(int a[], int b[]) {
    for(int i = 0; i < nfaStates; i++)
        if(a[i] != b[i])
            return 0;
    return 1;
}

// Epsilon closure
void epsilonClosure(int stateSet[], int result[]) {
    int stack[MAX_STATES], top = -1;

    for(int i = 0; i < nfaStates; i++) {
        result[i] = stateSet[i];
        if(stateSet[i])
            stack[++top] = i;
    }

    while(top != -1) {
        int state = stack[top--];

        for(int i = 0; i < nfaStates; i++) {
            if(nfa[state][epsilonIndex][i] && !result[i]) {
                result[i] = 1;
                stack[++top] = i;
            }
        }
    }
}

// Move function
void moveSet(int stateSet[], int symbolIndex, int result[]) {
    for(int i = 0; i < nfaStates; i++)
        result[i] = 0;

    for(int i = 0; i < nfaStates; i++) {
        if(stateSet[i]) {
            for(int j = 0; j < nfaStates; j++) {
                if(nfa[i][symbolIndex][j])
                    result[j] = 1;
            }
        }
    }
}

// Add DFA state
int addDFAState(int stateSet[]) {
    for(int i = 0; i < dfaCount; i++) {
        if(isSameSet(dfaStates[i], stateSet))
            return i;
    }

    for(int i = 0; i < nfaStates; i++)
        dfaStates[dfaCount][i] = stateSet[i];

    dfaMarked[dfaCount] = 0;
    return dfaCount++;
}

void convertNFAtoDFA() {
    int startSet[MAX_STATES] = {0};
    startSet[0] = 1;

    int closure[MAX_STATES];
    epsilonClosure(startSet, closure);

    addDFAState(closure);

    while(1) {
        int unmarked = -1;

        for(int i = 0; i < dfaCount; i++)
            if(!dfaMarked[i]) {
                unmarked = i;
                break;
            }

        if(unmarked == -1)
            break;

        dfaMarked[unmarked] = 1;

        for(int s = 0; s < nfaSymbols; s++) {
            if(s == epsilonIndex)
                continue;

            int moveResult[MAX_STATES];
            int closureResult[MAX_STATES];

            moveSet(dfaStates[unmarked], s, moveResult);
            epsilonClosure(moveResult, closureResult);

            int stateIndex = addDFAState(closureResult);
            dfaTrans[unmarked][s] = stateIndex;
        }
    }
}

// Print DFA
void printDFA() {
    printf("\nDFA Transition Table:\n");

    for(int i = 0; i < dfaCount; i++) {
        printf("D%d = { ", i);
        for(int j = 0; j < nfaStates; j++)
            if(dfaStates[i][j])
                printf("q%d ", j);
        printf("}\n");

        for(int s = 0; s < nfaSymbols; s++) {
            if(s == epsilonIndex)
                continue;

            printf("  On %c -> D%d\n", symbols[s], dfaTrans[i][s]);
        }
        printf("\n");
    }
}

int main() {
    printf("Enter number of NFA states: ");
    scanf("%d", &nfaStates);

    printf("Enter number of input symbols (including epsilon): ");
    scanf("%d", &nfaSymbols);

    printf("Enter symbols (use e for epsilon):\n");
    for(int i = 0; i < nfaSymbols; i++) {
        scanf(" %c", &symbols[i]);
        if(symbols[i] == 'e')
            epsilonIndex = i;
    }

    printf("Enter NFA transition table (0 or 1):\n");
    for(int i = 0; i < nfaStates; i++) {
        for(int j = 0; j < nfaSymbols; j++) {
            printf("From q%d on %c:\n", i, symbols[j]);
            for(int k = 0; k < nfaStates; k++)
                scanf("%d", &nfa[i][j][k]);
        }
    }

    convertNFAtoDFA();
    printDFA();

    return 0;
}
